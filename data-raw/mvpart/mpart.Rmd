---
title: "Testing mvpart"
output: 
  rmarkdown::html_document:
    toc: true
date: '`r Sys.Date()`'
---

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE
)
```

```{r}
library(dplyr)
library(mvpart)
```

# Installation

The __mvpart__ package is no longer active on CRAN but can be installed from the archives.

```R
# install.packages("devtools")
devtools::install_github("cran/mvpart")
```

Or download a realease from https://github.com/cran/mvpart/releases and install it with something like:

```R

install.packages(
  "C:/Users/dora/Desktop/mvpart-1.6-2.tar.gz", 
  repos = NULL, type = "source"
)
```

Some people reported installation issues (https://goo.gl/oDjjz8).



# Data

- Tutorial https://goo.gl/zDLdMi

- Data from Stuart Davies (https://goo.gl/).

```{r}
# mvpart

# From Stuart Davies https://goo.gl/NszXEi
# KC3spp20 – is the species matrix of abundance in each of 600 quadrats
# kc.hab – a bunch of habitat variables for the same 600 quadrats

kc.hab <- readr::read_csv("kc.hab.csv")
KC3spp20 <- readr::read_csv("KC3spp20.csv")
```


## Overview data

2 files attached:

- KC3spp20 – is the species matrix of abundance in each of 600 quadrats

```{r}
# See a few columns from the beginning, middle and end
KC3spp20 %>% dplyr::select(1:2, 250:252, 583:585)

# For a cleaner output for interpretation, normalized tree spp data to a mean of
# 0 and standard deviation of 1 (https://goo.gl/zDLdMi).
```

- kc.hab – a bunch of habitat variables for the same 600 quadrats

```{r}
kc.hab %>% dplyr::glimpse()
```

## Results

In this section, we first explore one result in detail; then we'll re-run the exact same model twice more and we'll compare the results.

### Build and run the model

```{r, fig.height=14, fig.width=12}
abundance <- data.matrix(KC3spp20)
environmental_variables <- kc.hab

formula <- abundance ~ RB_NO3 + RB_NH4 + RB_PO4 + Al + pH_water + Na + Mn + 
  Mg + K + Fe + Ca + BS + ECEC + Bray_P + meanelev + convex + slope

# Set a new seed for random numbers to ensure results are reproducible
set.seed(1221)
mvpart_run_cero <- mvpart(form = formula, data = environmental_variables)
```

### Model details

#### Structure

```{r}
str(mvpart_run_cero)
```

#### Full summary

```{r}
summary(mvpart_run_cero)
```

#### Groupings

```{r}
table( mvpart_run_cero$where)
```

#### Map

Map produced by Stuart Davies.

![](Screen Shot 2017-06-21 at 4.49.28 PM.png)

## Compare multiple runs of the same model

__Two runs of the same model are different because the algorithm uses random numbers.__

```{r}
set.seed(1234)  # Set a new seed for random numbers
mvpart_run_one <- mvpart(form = formula, data = environmental_variables)
# Set a different seed and re-run the exact same model
set.seed(4321)  
mvpart_run_two <- mvpart(form = formula, data = environmental_variables)
# compare run 1 and 2
all.equal(mvpart_run_one, mvpart_run_two)

# These two models are obviously different.
mvpart_run_one
mvpart_run_two
```

### Produce different grouping datasets from different runs


```{r}
# tibble::tibble(
#   mvpart_run_cero$where, mvpart_run_one$where, mvpart_run_two$where
# ) %>% 
#   purrr::map2(c("run1.csv", "run2.csv", "run2.csv"), readr::write_csv)
```

xxx export 
