---
title: "Report Package Quality"
author: "Mauro Lepore"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 6
vignette: >
  %\VignetteIndexEntry{Report Package Quality}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE
)
library(tibble)
library(dplyr)
library(sig)
```

# Complexity

One way of measuring the quality of a package is its complexity. To measure the complexity of the ctfs package, and to compare it to other packages, we will use the sig package. Best practice is to keep a package simple (_Testing R code_ by Richard Cotton).

## _ctfs_

This reports the complexity of ctfs:

```{r}
sig::sig_report(pkg2env(ctfs))
```

## _Hmisc_

For comparison, this is the same report on the Hmisc package, _the gold standard in monstrously big and complicated functions (_Testing R code_ by Richard Cotton, page 67).

```{r}
sig_report(pkg2env(Hmisc))
```

And the next two reports are of simple packages.

## _assertive_

```{r}
sig_report(pkg2env(assertive))
```

## _testthat_

```{r}
sig_report(pkg2env(testthat))
```

# Documentation

This section reports the quality of the documentation. It focuses not on how compleate or correct the documentation is, but on how accurately the documentation information has been programatically extracted from its original source (https://goo.gl/uAvQ1k) into the ctfs package documentation (roxygenized documentation in R their .Rd version in `man/`). That transformation is necessary for the roxygen2 package to create the ctfs documentation (i.e. help pages available via `?<FUNCTION_NAME>` in R and at https://forestgeo.github.io/ctfs/reference).

Choose some functions at random and visually check if documentation matches.

```{r, echo=FALSE}
tribble(
  ~fun, ~match_source, ~match_webpage,
  "arrangeParam.llike.2D", T, T,
  "attach_if_needed", T, T,
  "biomass.growth", T, T,
  "border.distance", T, T,
  "drawrectangle", T, T,
  "exponential.sin", T, T,
  "find.xaxis.hist", T, T,
  "graph.mvnorm", T, T,
  "linear.mortmodel", T, T,
  "logistic.power.mode", T, T,
  "pospower", T, T,
  "pts.to.interceptslope", T, T,
  "recalculate.lmerBayesllike", T, T,
  "saveParamFile", T, T,
  "skewness", T, T, 
  "summaryMCMC", T, T
)
```

# Functionality

This reports is key functions of tutorials run or err.

```{r}
# errors ----
err001 <- "Error in llike.model.lmer, function 'dmvnorm' was missing"
err002 <- "Error in tojulian, package date was missing"
err003 <- "Errs because uses subset, i.e. non-standard evaluation"
err004 <- "Errs because density.ind argument wsgdata is missing"
err005 <- paste0(err004, " and could also err because density.ind used subset")
err006 <- "Called from: linear.model. Error in x %*% b : requires numeric/complex matrix/vector arguments"

# solutions ----
solved_with <- tibble::tribble(
  ~fun, ~msg, ~guess_solution,
  "lmerBayes", err001, "use_package('mvtnorm'), use_package('MCMCpack')",
  "mortality.eachspp", err002, "use_package('date')",
  "model.littleR.Gibbs", err003, "remove subset (non-standard evaluation)",
  "biomass.CTFSdb", err004, "provide argument wsgdata with wsgdata_dummy()",
  "density.ind", err005, "remove subset (non-standard evaluation)"
)

# functions that err ----
errs <- tibble::tribble(
  ~tutorial, ~fun, ~errs,
  "Growth changes", "individual_grow.table", F,
  "Growth changes", "pospower", F,
  "Mortality changes", "individual_mort.table", F,
  "Mortality changes", "calcMortIndivTable", F,
  "Mortality changes", "growth.indiv", F,
  "Mortality changes", "lmerBayes", T,
  "Mortality vs. dbh", "mortality.eachspp", T,
  "Population Changes", "model.littleR.Gibbs", T,
  "Population Changes", "graph.abundmodel", F,
  "Population Changes", "fitSeveralAbundModel", F,
  "Biomass", "CTFSplot", F,
  "Biomass", "attach_if_needed", F,
  "Biomass", "biomass.CTFSdb", T,
  "Biomass", "Chave.AGB", F,
  "Biomass", "predht.asym", F,
  "Growth vs. DBH", "extract.growthdata", F,
  # "Growth vs. DBH", "extract.growthdata", T,
  # "ImageJ",
  # "Plot maps",
  # "Topography",
)
errs
dplyr::left_join(errs, solved_with) %>% filter(errs)
```

Finally, this reports if some more functions run or err. The functions, selected at random, are these:

```{r, include=FALSE}
# # Sample 30 functions at random (must run, not knit)
# set.seed(4435)
# library(dplyr)
# 
# tibble::tibble(fun = dir("./man/")) %>% 
#   dplyr::mutate(
#     fun = stringr::str_replace(fun, ".Rd$", "")
#   ) %>% 
#   dplyr::sample_n(30) %>% 
#   dplyr::pull()
```

```r
 [1] "regression.Bayes"         "dpois.trunc"             
 [3] "regslope.noint"           "logistic.power.mode"     
 [5] "quad.to.gxgy"             "CountByGroup"            
 [7] "angleBisector"            "ellipse"                 
 [9] "graph.growthmodel"        "order.by.rowcol"         
[11] "nhd"                      "graph.growthmodel.spp"   
[13] "coldata.to.imagemat"      "imageGraph"              
[15] "fullplot.imageJ"          "rasympower"              
[17] "residual.llike.lmerBayes" "asymp.ht"                
[19] "logistic.standard"        "covTocorr"               
[21] "arrangeParam.llike.2D"    "clean.demography"        
[23] "lmerMortFixedTime"        "bootconf"                
[25] "minum.perpdist"           "defineSDpar"             
[27] "cartesian.to.polar"       "rsymexp"                 
[29] "logistic.ctr"             "majoraxisreg"
```
