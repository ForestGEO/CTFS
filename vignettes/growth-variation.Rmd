---
title: "Growth variation through time"
subtitle: "Adapted by Mauro Lepore from the original tutorial by Richard Condit (https://goo.gl/c9RjMY)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"growth variation through time"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE
)
```

# Conventions to refer to code

I refer to code following the conventions of [R for data science](http://r4ds.had.co.nz/introduction.html), by Hadley Wickham & Garrett Grolemund:

> Functions are in a code font and followed by parentheses, like `sum()`, or `mean()`.

> Other R objects (like data or function arguments) are in a code font, without parentheses, like `flights` or `x`.

> If we want to make it clear what package an object comes from, weâ€™ll use the package name followed by two colons, like` dplyr::mutate()`, or `nycflights13::flights`. This is also valid R code.

# Hypotheses

The question addressed here is how growth has changed with time, in particular how species differ in growth changes. There are two alternative models described:

* Growth rate changing linearly with time
* Growth rate varying from census to census, but not following a consistent change

# Packages

The functions we use here come with the [ctfs](https://forestgeo.github.io/ctfs/) and [lme4](https://github.com/lme4/lme4/) packages, and the data comes in the [bci](https://forestgeo.github.io/bci/) package:

```{r, message=FALSE}
# installation instructions at https://github.com/forestgeo/ctfs
library(ctfs)
# installation instructions at https://github.com/lme4/lme4/
library(lme4)
# installation instructions at https://forestgeo.github.io/bci/
library(bci)
```


To access functions commonly used for data analysis, load the tidyverse package:

```{r, message=FALSE}
# install.packages("tidyverse")
library(tidyverse)
```

# Between census intervals, table growth rates of individual trees

First, let's table the growth rate of every tree in every census interval. To calculate growth rates for individual trees and table them in the format lmer understands, we use `ctfs::individual_grow.table()`. `individual_grow.table()` collects results from several other functions.

```{r}
# See default arguments, definition of output variables and other details with
# ?individual_grow.table

# Example choosing censuses 1-7
census17_chr <- paste0("bci12full", 1:7)
census17_list <- lapply(census17_chr, get)
grate <- individual_grow.table(
  census17_list, 
  mindbh = 400, maxdbh = 10000  # e.g. with trees of relatively large diameter
)

# Overview
head(grate)
dplyr::count(grate, census)  # 1, 2 ...: 1st, 2nd ... interval between censuses
```

# 2. Summarize mean growth, forest-wide

Second, for each census period, summarize the data to give the mean growth rate of all individuals.

```{r}
by_census <- dplyr::group_by(grate, census) 
growth_summary <- dplyr::summarize(by_census,
  yr_mean        = mean(time),       # mean years since 1992
  increment_mean = mean(incgr),      # mean of untransformed growth increment
  increment_med  = median(incgr),    # as above but median
  root_mean      = mean(CRGrowth),   # mean of cube root of growth rate
  root_med       = median(CRGrowth)  # as above but median
)
growth_summary
# (To refresh definition of variables in grate run ?individual_grow.table)
```

To visualize the growth summary, let's graph mean growth vs. time. Although you may simply graph the mean growth increment, here I use the mean of the cube-root of growth.

```{r}
exponent <- 0.45
growth_summary <- mutate(growth_summary, 
  root_exp = root_mean^(1/exponent)  # cube it to restore the original scale
  )

ggplot(data = growth_summary) +
  geom_line(aes(x = yr_mean, y = root_exp)) +
  labs(x = "years since 1992", y = "median growth increment")
```

# 3. Mixed model to assess species variation in linear changes through time











# References

[Repository](https://dx.doi.org/10.5479/data.bci.20130603) of the Barro Colorado Forest Census Plot Data (version 2012).

[Description](https://repository.si.edu/bitstream/handle/10088/20925/RoutputFull.pdf?sequence=1&isAllowed=y) of the Barro Colorado Forest Census Plot Data.

# Todo

MOST IMPORTANT

- Use data from several censuses in bci
- Document missing arguments in `individual_grow.table()`
- Document variable names of output in `individual_grow.table()`

LESS IMPORTANT

- track functions called by `individual_grow.table()`
